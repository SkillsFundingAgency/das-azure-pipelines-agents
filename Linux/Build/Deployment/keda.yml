apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: pipeline-trigger-auth
  namespace: __AgentNameSpace__
spec:
  secretTargetRef:
    - parameter: personalAccessToken
      name: azp
      key: AZP_TOKEN
      
---
apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: azure-pipelines-scaledjob
  namespace: __AgentNameSpace__
spec:
  jobTargetRef:
    template:
      spec:
        containers:
          - name: azure-pipeline-agent
            image: __PublicAcrName__.azurecr.io/__ContainerImageName__:__ImageTag__
            imagePullPolicy: Always
            env:
              - name: AZP_URL
                valueFrom:
                  secretKeyRef:
                    name: azp
                    key: AZP_URL
              - name: AZP_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: azp
                    key: AZP_TOKEN
              - name: AZP_POOL
                value: __AzureDevopsAgentPool__
              - name: NUGET_PACKAGES
                value: "/mnt/nugetcache/packages"
            volumeMounts:
              - mountPath: /var/run/docker.sock
                name: docker-volume
              - mountPath: "/mnt/nugetcache"
                name: nuget-cache
        restartPolicy: Never  # Ensure agents are not restarted after completion
  pollingInterval: 30  # Poll every 30 seconds for new jobs
  successfulJobsHistoryLimit: 5  # Retain last 5 successful jobs for history
  failedJobsHistoryLimit: 5  # Retain last 5 failed jobs for troubleshooting
  maxReplicaCount: __MaxAgentCount__  # Maximum number of agent jobs that can run concurrently
  scalingStrategy:
    strategy: "default"  # Options: accurate (for batch processing), fast (if you need more frequent scaling)
  triggers:
    - type: azure-pipelines
      metadata:
        poolID: "109" # Replace with your Azure DevOps Agent Pool ID
        organizationURLFromEnv: "AZP_URL"
        personalAccessTokenFromSecret: personalAccessToken
      authenticationRef:
        name: pipeline-trigger-auth